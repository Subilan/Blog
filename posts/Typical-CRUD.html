<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>常用 CRUD 前后端架构 | Subilan&#39;s Blog</title>
    <meta name="description" content="Satellite yourself.">
    <link rel="icon" href="https://fnmdp.oss-cn-beijing.aliyuncs.com/assets/avatar.png">
    
    <link rel="preload" href="/assets/css/0.styles.b3b0681a.css" as="style"><link rel="preload" href="/assets/js/app.2856f093.js" as="script"><link rel="preload" href="/assets/js/2.f4fee844.js" as="script"><link rel="preload" href="/assets/js/42.bda25a23.js" as="script"><link rel="prefetch" href="/assets/js/10.6db725e3.js"><link rel="prefetch" href="/assets/js/11.2c815676.js"><link rel="prefetch" href="/assets/js/12.48d04346.js"><link rel="prefetch" href="/assets/js/13.fca9202c.js"><link rel="prefetch" href="/assets/js/14.fdff9e59.js"><link rel="prefetch" href="/assets/js/15.d99cc1ce.js"><link rel="prefetch" href="/assets/js/16.3cfc86c3.js"><link rel="prefetch" href="/assets/js/17.1c15f083.js"><link rel="prefetch" href="/assets/js/18.919fd1e4.js"><link rel="prefetch" href="/assets/js/19.e605c9fe.js"><link rel="prefetch" href="/assets/js/20.b7b75b2e.js"><link rel="prefetch" href="/assets/js/21.e5641cdc.js"><link rel="prefetch" href="/assets/js/22.83aa5530.js"><link rel="prefetch" href="/assets/js/23.4418a553.js"><link rel="prefetch" href="/assets/js/24.2184870d.js"><link rel="prefetch" href="/assets/js/25.8890c95f.js"><link rel="prefetch" href="/assets/js/26.32dbfee2.js"><link rel="prefetch" href="/assets/js/27.60946b34.js"><link rel="prefetch" href="/assets/js/28.e4bd9073.js"><link rel="prefetch" href="/assets/js/29.9b371cd4.js"><link rel="prefetch" href="/assets/js/3.686d7c50.js"><link rel="prefetch" href="/assets/js/30.cbaab973.js"><link rel="prefetch" href="/assets/js/31.2eedca67.js"><link rel="prefetch" href="/assets/js/32.25c5c8a9.js"><link rel="prefetch" href="/assets/js/33.51a762b7.js"><link rel="prefetch" href="/assets/js/34.9444dad4.js"><link rel="prefetch" href="/assets/js/35.6295cf3e.js"><link rel="prefetch" href="/assets/js/36.80003479.js"><link rel="prefetch" href="/assets/js/37.479b4d54.js"><link rel="prefetch" href="/assets/js/38.ebf6a705.js"><link rel="prefetch" href="/assets/js/39.7892aad1.js"><link rel="prefetch" href="/assets/js/4.b3a073df.js"><link rel="prefetch" href="/assets/js/40.fa81d1be.js"><link rel="prefetch" href="/assets/js/41.aead0fd3.js"><link rel="prefetch" href="/assets/js/43.d78edae4.js"><link rel="prefetch" href="/assets/js/44.c5872af1.js"><link rel="prefetch" href="/assets/js/5.24bf910d.js"><link rel="prefetch" href="/assets/js/6.80644ee6.js"><link rel="prefetch" href="/assets/js/7.2c6349dd.js"><link rel="prefetch" href="/assets/js/8.398b6d48.js"><link rel="prefetch" href="/assets/js/9.b31347a1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b3b0681a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-64d03402><header class="navbar" data-v-64d03402><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Subilan's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/Friends.html" class="nav-link">友链</a></div><div class="nav-item"><a href="/About.html" class="nav-link">关于</a></div><div class="nav-item"><a href="/Contact.html" class="nav-link">联系</a></div><div class="nav-item"><a href="/PGP.html" class="nav-link">公钥</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-64d03402></div> <aside class="sidebar" data-v-64d03402><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/Friends.html" class="nav-link">友链</a></div><div class="nav-item"><a href="/About.html" class="nav-link">关于</a></div><div class="nav-item"><a href="/Contact.html" class="nav-link">联系</a></div><div class="nav-item"><a href="/PGP.html" class="nav-link">公钥</a></div> <!----></nav>  <!----> </aside> <main class="page" data-v-64d03402> <div class="theme-default-content content__default"><h1 id="常用-crud-前后端架构"><a href="#常用-crud-前后端架构" aria-hidden="true" class="header-anchor">#</a> 常用 CRUD 前后端架构</h1> <p>在写一些自用的小程序（not wechat mini-programs）或者搭建一个简易的前后台关系时，通常都要进行以下几点的设计</p> <ul><li>前后端请求—返回数据的约定</li> <li>数据库的调用</li> <li>登录认证</li> <li>分页</li></ul> <p>显然这些设计可以被模式化和模板化，从而提高创建它们的效率。</p> <p>而不将它们完全作为模板，是因为在这之间还存在着相当大的需求变量；代码层面上，在此基础上可以进行其它扩充。例如对于即使更新的需求，可以加入 websocket 等模块（<s>虽然大多数情况下为了省事，我选择 CRUD 轮询</s>）；以及为了安全性可以进行更多修改和优化，等等。</p> <p>下面以 TypeScript 和 Python 举例，其它语言同理。</p> <h2 id="请求—返回数据的约定"><a href="#请求—返回数据的约定" aria-hidden="true" class="header-anchor">#</a> 请求—返回数据的约定</h2> <p>首先，我们在后端使用统一的函数进行返回。例如</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">response</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> data<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">'data'</span><span class="token punctuation">:</span> data<span class="token punctuation">,</span>
        <span class="token string">'status'</span><span class="token punctuation">:</span> status<span class="token punctuation">,</span>
        <span class="token string">'msg'</span><span class="token punctuation">:</span> msg
    <span class="token punctuation">}</span>

data <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
message <span class="token operator">=</span> <span class="token string">'An error occurred.'</span>

response<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token string">'ok'</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
response<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token string">'error'</span><span class="token punctuation">,</span> msg<span class="token operator">=</span>message<span class="token punctuation">)</span>
</code></pre></div><p>利用 <a href="https://axios-http.com/" target="_blank" rel="noopener noreferrer">axios<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，可以方便地处理返回数据的类型。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// axios 默认返回中，data 才是后端来的数据。</span>
axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
    <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span>data
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">// ...</span>

<span class="token keyword">interface</span> <span class="token class-name">ReponseType</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token comment">// 可调整</span>
    status<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    msg<span class="token punctuation">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> axios<span class="token punctuation">.</span>post<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> ReponseType<span class="token operator">&gt;</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 可用于添加 Authorization</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>ResponseType</code> 即为返回值的骨架类型，可以放在 <code>axios.post</code> 和 <code>axios.get</code> 两个函数的第二个泛型参数上指定返回值（即在 interceptor 里拦截到的 <code>response.data</code>）的类型。</p> <p>这样在请求时大致就是如下的情形了：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/abc'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    abc<span class="token punctuation">:</span> <span class="token string">'def'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'ok'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="数据库的调用"><a href="#数据库的调用" aria-hidden="true" class="header-anchor">#</a> 数据库的调用</h2> <p>数据的调用，在 Python 里通常使用 <code>pymysql</code> 库。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> pymysql <span class="token keyword">import</span> connect<span class="token punctuation">,</span> cursors

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">'abc'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'def'</span><span class="token punctuation">,</span> database<span class="token operator">=</span><span class="token string">'target_db'</span><span class="token punctuation">,</span> cursorclass<span class="token operator">=</span>cursors<span class="token punctuation">.</span>DictCursor<span class="token punctuation">)</span>
</code></pre></div><p>注意到 <code>cursorclass</code> 在这里是一个很重要的参数。在 PHP 的 <code>mysqli</code> 中，通常是通过指定 <code>mysqli::fetch_all</code> 的第一个参数 <code>int $mode</code> 来实现的。这里的 <code>cursors.DictCursor</code> 对应 <code>MYSQLI_ASSOC</code>。</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$mysqli</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mysqli</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'localhost'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'abc'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'def'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'target_db'</span><span class="token punctuation">)</span>

<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$mysqli</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;SELECT ...&quot;</span><span class="token punctuation">)</span>

<span class="token variable">$rows</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">fetch_all</span><span class="token punctuation">(</span><span class="token constant">MYSQLI_ASSOC</span><span class="token punctuation">)</span>
</code></pre></div><p>然后对于内容的取得就是如同上面 php 代码里所示的司空见惯的逻辑。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">with</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
    <span class="token keyword">with</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cur<span class="token punctuation">:</span>
        cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>conn<span class="token punctuation">.</span>escape_string<span class="token punctuation">(</span><span class="token string">'SELECT ...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> cur<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 或者</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="登录认证"><a href="#登录认证" aria-hidden="true" class="header-anchor">#</a> 登录认证</h2> <p>登录认证的设计流程已经在<a href="/posts/Simple-Authenticating-System.html">这里</a>有概述。本文所展示的是使用 <code>jwt</code> 库所实现的 Python 版本。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> jwt <span class="token keyword">import</span> encode<span class="token punctuation">,</span> decode<span class="token punctuation">,</span> DecodeError

<span class="token keyword">def</span> <span class="token function">getToken</span><span class="token punctuation">(</span>argument1<span class="token punctuation">,</span> argument2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'iat'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'exp'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 可调整</span>
        <span class="token string">'argument1'</span><span class="token punctuation">:</span> argument1<span class="token punctuation">,</span>
        <span class="token string">'argument2'</span><span class="token punctuation">:</span> argument2
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> encode<span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token string">'secret'</span><span class="token punctuation">,</span> <span class="token string">'HS256'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">verifyToken</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> jwt <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        decoded <span class="token operator">=</span> decode<span class="token punctuation">(</span>jwt<span class="token punctuation">,</span> <span class="token string">'secret'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'HS256'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> DecodeError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">if</span> decoded<span class="token punctuation">[</span><span class="token string">'exp'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token keyword">def</span> <span class="token function">decodeToken</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> verify<span class="token punctuation">(</span>jwt<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">assert</span> jwt <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token comment"># verify 函数确保 jwt 不是 None</span>
    <span class="token keyword">return</span> decode<span class="token punctuation">(</span>jwt<span class="token punctuation">,</span> <span class="token string">'secret'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'HS256'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>然后在前端以一种安全的方式提交给后端即可，例如使用 Authorization Header。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token comment">/* ...*/</span>token<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            Authorization<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">JWT </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>后端在验证时，可以使用函数包装，将目标函数添加相应的检测流程。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps
<span class="token keyword">from</span> flask <span class="token keyword">import</span> request

<span class="token keyword">def</span> <span class="token function">protected</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token comment"># 必须</span>
    <span class="token keyword">def</span> <span class="token function">decorated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        auth <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> auth <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> response<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token string">'invalid'</span><span class="token punctuation">)</span>
        token <span class="token operator">=</span> auth<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;JWT &quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> response<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token string">'invalid'</span><span class="token punctuation">)</span>
        tokenStr <span class="token operator">=</span> token<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> verifyToken<span class="token punctuation">(</span>tokenStr<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> response<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token string">'invalid'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> decorated

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
@protected
<span class="token keyword">def</span> <span class="token function">api</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>
    <span class="token keyword">return</span> <span class="token comment"># ...</span>
</code></pre></div><h2 id="分页"><a href="#分页" aria-hidden="true" class="header-anchor">#</a> 分页</h2> <p>要完成分页，首先需要给数据增添数字标识，从而使得数据有序且顺序可比。这一点通常通过一个名为 id 的 key column 实现。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>example<span class="token punctuation">`</span> <span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span>
<span class="token punctuation">)</span>
</code></pre></div><p>分页时，需要考虑到</p> <ul><li>每页数据的数目 — 对应 SQL 中的 <code>LIMIT</code></li> <li>数据的排列顺序 — 对应 SQL 中的 <code>ORDER BY</code></li></ul> <p>且前端分页通常需要后端对下一页数据的预测数据的辅助。</p> <p>例如我们简单地选取表中最开始的 10 个升序排列的行。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> id <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id <span class="token keyword">ASC</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment"># 或者</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> id <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id <span class="token keyword">ASC</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre></div><p>这可以作为第一页的内容。此时符合条件的行应当是 <code>id</code> 从 1 到 10 的所有行（没有 <code>id</code> 缺省的情况下）。接下来选择第二页的内容，即为</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> id <span class="token operator">&gt;=</span> <span class="token number">11</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id <span class="token keyword">ASC</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment"># 或者</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> id <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id <span class="token keyword">ASC</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre></div><p>然而在这里，大于号后面所跟的内容并不一定是 <code>10</code> 或者 <code>11</code>，因为可能中途有 <code>id</code> 的缺省。所以，这时候需要前端指定当前页面的最后一个数据的 <code>id</code> 提交给后端。我们将其称为 <code>indicatorId</code>。</p> <p>于是更加准确的 SQL 应当写作</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> id <span class="token operator">&gt;</span> indicatorId <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id <span class="token keyword">ASC</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre></div><p>Python 语句示例：</p> <div class="language-python extra-class"><pre class="language-python"><code>indicatorId <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'indicator'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
pageSize <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'pageSize'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM table WHERE id &gt; {0} ORDER BY id ASC LIMIT {1}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>indicatorId<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span>
</code></pre></div><p>注意这里应当使用 <code>&gt;</code> 而不是 <code>&gt;=</code>。若要使用后者，则需要多一个 <code>+1</code> 的步骤。</p> <p>同时，后端需要返回前端一个「是否有下一页」的信息，可让前端判断是否需要展示「下一页」的按钮。这一点在下滑加载（即滑到数据底部后，在底部添加上新的数据）的场景中比较适用。</p> <p>判断是否有下一页，在升序中，只需要判断 <code>indicatorId</code> 是否就是表最后一行数据的 <code>id</code>；在降序中，只需要判断 <code>indicatorId</code> 是否就是表第一行数据的 <code>id</code>。</p> <div class="language-python extra-class"><pre class="language-python"><code>hasNext <span class="token operator">=</span> indicator <span class="token operator">!=</span> lastRowId <span class="token keyword">if</span> order <span class="token operator">==</span> <span class="token string">'asc'</span> <span class="token keyword">else</span> indicator <span class="token operator">!=</span> firstRowId
</code></pre></div><p>如果要采用不同页加载（即每一页展示固定数量的数据，以页码标记页面）的场景，则可以返回一个总的页码数据。</p> <div class="language-python extra-class"><pre class="language-python"><code>rowAmount <span class="token operator">=</span> count<span class="token punctuation">(</span><span class="token string">'table'</span><span class="token punctuation">)</span> <span class="token comment"># count 函数返回一个表的（指定条件的）总行数</span>
pageAmount <span class="token operator">=</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>rowAmount <span class="token operator">/</span> pageSize<span class="token punctuation">)</span>
hasNext <span class="token operator">=</span> currentPage <span class="token operator">&lt;</span> pageAmount
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新于: </span> <span class="time">2023/7/13</span></div></footer> <!----> </main> <footer class="footer" data-v-7a770bda data-v-64d03402><div class="copyright" data-v-7a770bda>© 2019-2023 Subilan</div> <div class="license" data-v-7a770bda>Based on <a target="_blank" href="//vuepress.vuejs.org" data-v-7a770bda>VuePress</a></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2856f093.js" defer></script><script src="/assets/js/2.f4fee844.js" defer></script><script src="/assets/js/42.bda25a23.js" defer></script>
  </body>
</html>
