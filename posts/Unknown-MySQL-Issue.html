<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>记一次奇怪的 MySQL 错误解决 | Subilan&#39;s Blog</title>
    <meta name="description" content="Satellite yourself.">
    <link rel="icon" href="https://fnmdp.oss-cn-beijing.aliyuncs.com/assets/avatar.png">
    
    <link rel="preload" href="/assets/css/0.styles.b3b0681a.css" as="style"><link rel="preload" href="/assets/js/app.2856f093.js" as="script"><link rel="preload" href="/assets/js/2.f4fee844.js" as="script"><link rel="preload" href="/assets/js/43.d78edae4.js" as="script"><link rel="prefetch" href="/assets/js/10.6db725e3.js"><link rel="prefetch" href="/assets/js/11.2c815676.js"><link rel="prefetch" href="/assets/js/12.48d04346.js"><link rel="prefetch" href="/assets/js/13.fca9202c.js"><link rel="prefetch" href="/assets/js/14.fdff9e59.js"><link rel="prefetch" href="/assets/js/15.d99cc1ce.js"><link rel="prefetch" href="/assets/js/16.3cfc86c3.js"><link rel="prefetch" href="/assets/js/17.1c15f083.js"><link rel="prefetch" href="/assets/js/18.919fd1e4.js"><link rel="prefetch" href="/assets/js/19.e605c9fe.js"><link rel="prefetch" href="/assets/js/20.b7b75b2e.js"><link rel="prefetch" href="/assets/js/21.e5641cdc.js"><link rel="prefetch" href="/assets/js/22.83aa5530.js"><link rel="prefetch" href="/assets/js/23.4418a553.js"><link rel="prefetch" href="/assets/js/24.2184870d.js"><link rel="prefetch" href="/assets/js/25.8890c95f.js"><link rel="prefetch" href="/assets/js/26.32dbfee2.js"><link rel="prefetch" href="/assets/js/27.60946b34.js"><link rel="prefetch" href="/assets/js/28.e4bd9073.js"><link rel="prefetch" href="/assets/js/29.9b371cd4.js"><link rel="prefetch" href="/assets/js/3.686d7c50.js"><link rel="prefetch" href="/assets/js/30.cbaab973.js"><link rel="prefetch" href="/assets/js/31.2eedca67.js"><link rel="prefetch" href="/assets/js/32.25c5c8a9.js"><link rel="prefetch" href="/assets/js/33.51a762b7.js"><link rel="prefetch" href="/assets/js/34.9444dad4.js"><link rel="prefetch" href="/assets/js/35.6295cf3e.js"><link rel="prefetch" href="/assets/js/36.80003479.js"><link rel="prefetch" href="/assets/js/37.479b4d54.js"><link rel="prefetch" href="/assets/js/38.ebf6a705.js"><link rel="prefetch" href="/assets/js/39.7892aad1.js"><link rel="prefetch" href="/assets/js/4.b3a073df.js"><link rel="prefetch" href="/assets/js/40.fa81d1be.js"><link rel="prefetch" href="/assets/js/41.aead0fd3.js"><link rel="prefetch" href="/assets/js/42.bda25a23.js"><link rel="prefetch" href="/assets/js/44.c5872af1.js"><link rel="prefetch" href="/assets/js/5.24bf910d.js"><link rel="prefetch" href="/assets/js/6.80644ee6.js"><link rel="prefetch" href="/assets/js/7.2c6349dd.js"><link rel="prefetch" href="/assets/js/8.398b6d48.js"><link rel="prefetch" href="/assets/js/9.b31347a1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b3b0681a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-64d03402><header class="navbar" data-v-64d03402><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Subilan's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/Friends.html" class="nav-link">友链</a></div><div class="nav-item"><a href="/About.html" class="nav-link">关于</a></div><div class="nav-item"><a href="/Contact.html" class="nav-link">联系</a></div><div class="nav-item"><a href="/PGP.html" class="nav-link">公钥</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-64d03402></div> <aside class="sidebar" data-v-64d03402><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/Friends.html" class="nav-link">友链</a></div><div class="nav-item"><a href="/About.html" class="nav-link">关于</a></div><div class="nav-item"><a href="/Contact.html" class="nav-link">联系</a></div><div class="nav-item"><a href="/PGP.html" class="nav-link">公钥</a></div> <!----></nav>  <!----> </aside> <main class="page" data-v-64d03402> <div class="theme-default-content content__default"><h1 id="记一次奇怪的-mysql-错误解决"><a href="#记一次奇怪的-mysql-错误解决" aria-hidden="true" class="header-anchor">#</a> 记一次奇怪的 MySQL 错误解决</h1> <p>今天部署一个 PHP 后端的时候，发现在本地（Windows）测试可以连上数据库，而在生产环境（Ubuntu 20.04）上却报 Permission denied 错误，密码都是正确的，看来还是 Ubuntu 的安全弄得好哟😅，随便去 Google 了一下发现如果要用 root 登录必须得加上 <code>sudo</code>？太奇妙了，于是一秒想到去创建一个新的用户。</p> <p><em>错误大概是这样的，一个很平凡的 Access denied。</em></p> <div class="language-log extra-class"><pre class="language-text"><code>(HY000/1698): Access denied for user 'root'@'localhost'
</code></pre></div><p>然后我就去创建新的用户了，具体流程老生常谈了</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'rootp'</span><span class="token variable">@'localhost'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'...'</span><span class="token punctuation">;</span> <span class="token comment">-- 不是 root 就可以，嘻嘻</span>
<span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'rootp'</span><span class="token variable">@'localhost'</span><span class="token punctuation">;</span>
FLUSH <span class="token keyword">PRIVILEGES</span><span class="token punctuation">;</span>
</code></pre></div><p>然后就离开了数据库。就在这个时候我突然不知道怎么想的想要重启一下数据库，虽然这种情况下不重启是完全可以的。重启就重启吧，反正不是甚么高危操作，可这一重启可给爷整麻了啊，出现了我从来没有见过的错误，甚至觉得 MariaDB 在逗我。报错信息大概是这样的：</p> <div class="language-log extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><div class="highlighted"> </div><br></div><pre class="language-text"><code>Aug 06 01:35:42 server systemd[1]: Starting MariaDB 10.1.47 database server...
-- Subject: Unit mariadb.service has begun start-up
-- Defined-By: systemd
-- Support: http://www.ubuntu.com/support
--
-- Unit mariadb.service has begun starting up.
Aug 06 01:35:43 server mysqld[4431]: 2021-08-06  1:35:43 140103940127872 [Note] /usr/sbin/mysqld (mysqld 10.1.47-MariaDB-0ubuntu0.18.04.1) starting as process 4431 ...
Aug 06 01:35:46 server systemd[1]: mariadb.service: Main process exited, code=exited, status=7/NOTRUNNING
Aug 06 01:35:46 server systemd[1]: mariadb.service: Failed with result 'exit-code'.
Aug 06 01:35:46 server systemd[1]: Failed to start MariaDB 10.1.47 database server.
-- Subject: Unit mariadb.service has failed
-- Defined-By: systemd
-- Support: http://www.ubuntu.com/support
--
-- Unit mariadb.service has failed.
--
-- The result is RESULT.
</code></pre></div><p>看看高亮的行，说的是 SQL 话吗？啥叫作 <code>Failed with result 'exit-code'</code>、<code>The result is RESULT</code>？笑死，听君一席话，如听一席话！无论怎么去查，得到的结果都不是完全符合，但是它们都有一个共性就是——你要重装你的 MySQL。确实，重装是一个完美的办法，我也很喜欢，干脆利落不用费事费力想办法，可是——我的数据！MySQL 死了，所以 <code>mysqldump</code> 也用不了...这是个悖论，我的数据可能取不回来了，那真是够恐怖。但是我忽然又想到，MySQL 一定是通过文件来存储数据的，于是我搜到了下面这段话。</p> <blockquote><p>What you should do is image your drive, copy it to something else, in preparation for your reinstall. I'd recommend copying everything as authentically as you can, even if that takes a while. That feeling you get when you realize you forgot to salvage something important that is now gone forever is not good.</p> <p>MySQL generally stores data in the data directory. It may take some work to get your MySQL back into the same configuration as before, so be sure to grab the appropriate my.cnf file.</p> <p>It can be really difficult to extract data from a bunch of MySQL data files without the MySQL process actually running. This is why tools like mysqldump exist. If you can get it running, even limping along, that'll be good enough to snapshot it.
<br><br> <em>来自 <a href="https://stackoverflow.com/questions/20130706/backup-dead-mysql-server" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/20130706/backup-dead-mysql-server<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em></p></blockquote> <p>这段话告诉我，将来的路会很坎坷...啊这，我只是想要重启个 MySQL，用得着这样对我吗。束手无策的时候，我突然想到，既然要重装，要不把数据都换个位置试试？也就是说把整个 MySQL 用来存放数据的文件夹换到另外一个地方，嗯，换个新的环境，没准就可以了。就是这个奇妙的脑回路拯救了我。</p> <p>首先，遇到了一个很坑的地方，那就是不确定数据在哪里。网上说的默认在 <code>/var/lib/mysql</code>，虽然我也发现那里有很多文件，也是不敢确定。然后又有的说可以在配置文件 <code>/etc/mysql/mysql.conf.d/mysqld.cnf</code> 里面看，结果并没有这个文件，也许是因为我是 MariaDB，所以应该在 <code>/etc/mysql/my.cnf</code> 里面。确实有这个文件，但是里面并没有 <code>datadir</code> 这个参数，真是醉了。到后来我鼓起勇气把 <code>datadir</code> 设置成了 <code>/mysql-db</code>，开始了迁移之路。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> /mysql-db
<span class="token function">rsync</span> -av /var/lib/mysql/ /mysql-db
<span class="token function">chmod</span> <span class="token number">755</span> /mysql-db
</code></pre></div><p>盘点一下这里的坑，首先 <code>rsync</code> 的第二个参数 <code>/var/lib/mysql/</code> 的最后带不带 <code>/</code> 是有区别的。带上了就代表 <code>/var/lib/mysql/*</code>，不带上就代表这个目录本身。刚开始没有带，复制了以后也没有去 <code>ls /mysql-db</code> 导致启动的时候刷了一大堆 not found 报错...然后就是权限问题，应该是 <code>755</code>。</p> <div class="tip custom-block"><p>为啥不用 <code>mv *</code>？因为当时想不到 <code>mv</code>，别骂了</p></div> <p>然后还有一个点就是要去 apparmor 里面创建一个别名。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vim</span> /etc/apparmor.d/tunables/alias
</code></pre></div><p>添加 <code>alias /var/lib/mysql -&gt; /mysql-db</code>，然后 <code>systemctl restart apparmor</code>。接下来就可以准备启动 MySQL 了。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl start mysql
</code></pre></div><p>让我震惊的是这次启动没有报错了。原理还待解释，不过我一秒就去全量备份了一下，因为有了备份就可以直接重装就没有这么多破事了😅</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mysqldump -u root --all-databases <span class="token operator">&gt;</span> /alldb.sql
</code></pre></div><p>然后还可以在 cron 里面加一个定时的备份，为了避免输入密码，可以创建一个 <code>~/my.cnf</code> 然后写入内容</p> <div class="language-conf extra-class"><pre class="language-text"><code>[mysqldump]
user=root
password=...
</code></pre></div><p>然后在 <code>crontab -e</code> 里面加入</p> <div class="language-crontab extra-class"><pre class="language-text"><code>10 * * * * mysqldump -u root --all-databases &gt; /alldb.sql
</code></pre></div><p>就可以了。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新于: </span> <span class="time">2023/7/13</span></div></footer> <!----> </main> <footer class="footer" data-v-7a770bda data-v-64d03402><div class="copyright" data-v-7a770bda>© 2019-2023 Subilan</div> <div class="license" data-v-7a770bda>Based on <a target="_blank" href="//vuepress.vuejs.org" data-v-7a770bda>VuePress</a></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2856f093.js" defer></script><script src="/assets/js/2.f4fee844.js" defer></script><script src="/assets/js/43.d78edae4.js" defer></script>
  </body>
</html>
